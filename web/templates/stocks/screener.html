{% extends 'base.html' %}

{% block title %}KOSPI200 스크리너 - Korean Stock Quant{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-funnel"></i> KOSPI 200 스크리너</h2>

    <div class="row">
        <!-- Filter Panel -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-sliders"></i> 필터 설정
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">지표 선택</label>
                        <select class="form-select" id="indicatorSelect">
                            {% for ind in indicators %}
                            <option value="{{ ind.id }}">{{ ind.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">신호 필터</label>
                        <select class="form-select" id="signalFilter">
                            <option value="">전체</option>
                            <option value="1">매수 신호만</option>
                            <option value="-1">매도 신호만</option>
                        </select>
                    </div>

                    <!-- RSI Parameters -->
                    <div id="rsi-screener-params" class="indicator-params">
                        <hr>
                        <h6>RSI 파라미터</h6>
                        <div class="mb-2">
                            <label class="form-label small">Period</label>
                            <input type="number" class="form-control form-control-sm" id="screenerRsiPeriod" value="14" min="2" max="50">
                        </div>
                    </div>

                    <!-- BB Parameters -->
                    <div id="bb-screener-params" class="indicator-params" style="display: none;">
                        <hr>
                        <h6>Bollinger Bands 파라미터</h6>
                        <div class="mb-2">
                            <label class="form-label small">Period</label>
                            <input type="number" class="form-control form-control-sm" id="screenerBbPeriod" value="20" min="5" max="50">
                        </div>
                        <div>
                            <label class="form-label small">Std Dev</label>
                            <input type="number" class="form-control form-control-sm" id="screenerBbStdDev" value="2" min="1" max="4" step="0.5">
                        </div>
                    </div>

                    <!-- Stochastic Parameters -->
                    <div id="stoch-screener-params" class="indicator-params" style="display: none;">
                        <hr>
                        <h6>Stochastic 파라미터</h6>
                        <div class="mb-2">
                            <label class="form-label small">%K Period</label>
                            <input type="number" class="form-control form-control-sm" id="screenerStochK" value="14" min="2" max="50">
                        </div>
                    </div>

                    <hr>

                    <button class="btn btn-primary w-100" id="runScreener">
                        <i class="bi bi-play-fill"></i> 스크리닝 실행
                    </button>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-table"></i> 스크리닝 결과</span>
                    <span id="result-count" class="badge bg-secondary">0건</span>
                </div>
                <div class="card-body">
                    <div id="screener-loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">스크리닝 중... (KOSPI 200 전 종목 분석)</p>
                    </div>

                    <div id="screener-placeholder" class="text-center py-5 text-muted">
                        <i class="bi bi-funnel fs-1"></i>
                        <p class="mt-2">필터를 설정하고 "스크리닝 실행" 버튼을 클릭하세요.</p>
                    </div>

                    <div id="screener-results" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped">
                                <thead class="table-dark">
                                    <tr>
                                        <th>종목코드</th>
                                        <th>종목명</th>
                                        <th class="text-end">현재가</th>
                                        <th class="text-center">신호</th>
                                        <th>신호일자</th>
                                        <th id="indicator-value-header">지표값</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const indicatorSelect = document.getElementById('indicatorSelect');
    const signalFilter = document.getElementById('signalFilter');
    const runButton = document.getElementById('runScreener');

    // Show/hide indicator params based on selection
    indicatorSelect.addEventListener('change', function() {
        document.querySelectorAll('.indicator-params').forEach(el => el.style.display = 'none');
        const paramDiv = document.getElementById(this.value.toLowerCase() + '-screener-params');
        if (paramDiv) {
            paramDiv.style.display = 'block';
        }
    });

    // Run screener
    runButton.addEventListener('click', async function() {
        const indicator = indicatorSelect.value;
        const signal = signalFilter.value;

        // Build query params
        let params = new URLSearchParams();
        params.append('indicator', indicator);
        if (signal) {
            params.append('signal', signal);
        }

        // Add indicator-specific params
        if (indicator === 'RSI') {
            const period = document.getElementById('screenerRsiPeriod').value;
            if (period) params.append('period', period);
        } else if (indicator === 'BB') {
            const period = document.getElementById('screenerBbPeriod').value;
            const stdDev = document.getElementById('screenerBbStdDev').value;
            if (period) params.append('period', period);
            if (stdDev) params.append('std_dev', stdDev);
        } else if (indicator === 'STOCH') {
            const kPeriod = document.getElementById('screenerStochK').value;
            if (kPeriod) params.append('k_period', kPeriod);
        }

        // Show loading
        document.getElementById('screener-placeholder').style.display = 'none';
        document.getElementById('screener-results').style.display = 'none';
        document.getElementById('screener-loading').style.display = 'block';

        try {
            const response = await fetch(`/api/screener/run/?${params.toString()}`);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            displayResults(data.results, indicator);
        } catch (error) {
            alert('스크리닝 중 오류가 발생했습니다: ' + error.message);
            document.getElementById('screener-loading').style.display = 'none';
            document.getElementById('screener-placeholder').style.display = 'block';
        }
    });

    function displayResults(results, indicator) {
        document.getElementById('screener-loading').style.display = 'none';
        document.getElementById('screener-results').style.display = 'block';
        document.getElementById('result-count').textContent = results.length + '건';

        // Update indicator value header
        let headerText = '지표값';
        if (indicator === 'RSI') headerText = 'RSI';
        else if (indicator === 'BB') headerText = 'BB %B';
        else if (indicator === 'STOCH') headerText = '%K / %D';
        document.getElementById('indicator-value-header').textContent = headerText;

        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';

        if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">조건에 맞는 종목이 없습니다.</td></tr>';
            return;
        }

        results.forEach(stock => {
            const row = document.createElement('tr');

            // Signal badge
            let signalBadge = '';
            if (stock.signal === 1) {
                signalBadge = '<span class="badge bg-success">매수</span>';
            } else if (stock.signal === -1) {
                signalBadge = '<span class="badge bg-danger">매도</span>';
            } else {
                signalBadge = '<span class="badge bg-secondary">-</span>';
            }

            // Indicator value
            let indicatorValue = '-';
            if (indicator === 'RSI' && stock.rsi !== undefined) {
                indicatorValue = stock.rsi.toFixed(2);
            } else if (indicator === 'BB' && stock.bb_percent !== undefined) {
                indicatorValue = stock.bb_percent.toFixed(2);
            } else if (indicator === 'STOCH' && stock.stoch_k !== undefined) {
                indicatorValue = stock.stoch_k.toFixed(2) + ' / ' + stock.stoch_d.toFixed(2);
            }

            row.innerHTML = `
                <td><a href="/stock/${stock.symbol}/">${stock.symbol}</a></td>
                <td>${stock.name}</td>
                <td class="text-end">${stock.price.toLocaleString()}</td>
                <td class="text-center">${signalBadge}</td>
                <td>${stock.signal_date || '-'}</td>
                <td>${indicatorValue}</td>
            `;

            tbody.appendChild(row);
        });
    }
});
</script>
{% endblock %}
