{% extends 'base.html' %}

{% block title %}KOSPI200 모멘텀 스크리너 - Korean Stock Quant{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4"><i class="bi bi-funnel"></i> KOSPI 200 모멘텀 스크리너</h2>

    <div class="row">
        <!-- Filter Panel -->
        <div class="col-lg-3 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <i class="bi bi-sliders"></i> 필터 설정
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">신호 필터</label>
                        <select class="form-select" id="signalFilter">
                            <option value="">전체</option>
                            <option value="1">매수 신호만</option>
                            <option value="-1">매도 신호만</option>
                        </select>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">모멘텀 상태</label>
                        <select class="form-select" id="stateFilter">
                            <option value="">전체</option>
                            <option value="VERY_STRONG_BULLISH">매우 강한 상승</option>
                            <option value="BULLISH">상승</option>
                            <option value="SLIGHTLY_BULLISH">약한 상승</option>
                            <option value="NEUTRAL">중립</option>
                            <option value="SLIGHTLY_BEARISH">약한 하락</option>
                            <option value="BEARISH">하락</option>
                            <option value="VERY_STRONG_BEARISH">매우 강한 하락</option>
                        </select>
                    </div>

                    <hr>
                    <h6>점수 범위 필터</h6>
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label small">최소 점수</label>
                            <input type="number" class="form-control form-control-sm" id="minScore" value="" min="0" max="100" placeholder="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label small">최대 점수</label>
                            <input type="number" class="form-control form-control-sm" id="maxScore" value="" min="0" max="100" placeholder="100">
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="forceRecompute">
                        <label class="form-check-label small" for="forceRecompute">
                            캐시 무시하고 재계산
                        </label>
                    </div>

                    <hr>

                    <button class="btn btn-primary w-100" id="runScreener">
                        <i class="bi bi-play-fill"></i> 스크리닝 실행
                    </button>
                </div>
            </div>

            <!-- Score Legend -->
            <div class="card mt-3">
                <div class="card-header">
                    <i class="bi bi-info-circle"></i> 점수 해석
                </div>
                <div class="card-body small">
                    <div class="d-flex justify-content-between mb-1">
                        <span class="badge bg-success">80-100</span>
                        <span>매우 강한 상승</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="badge bg-success bg-opacity-75">65-80</span>
                        <span>상승</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="badge bg-secondary">45-65</span>
                        <span>중립</span>
                    </div>
                    <div class="d-flex justify-content-between mb-1">
                        <span class="badge bg-danger bg-opacity-75">20-45</span>
                        <span>하락</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span class="badge bg-danger">0-20</span>
                        <span>매우 강한 하락</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Results -->
        <div class="col-lg-9">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-table"></i> 스크리닝 결과</span>
                    <span id="result-count" class="badge bg-secondary">0건</span>
                </div>
                <div class="card-body p-0">
                    <div id="screener-loading" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <p class="mt-2 text-muted">스크리닝 중... (KOSPI 200 전 종목 분석)</p>
                        <p class="small text-muted">첫 실행 시 시간이 소요될 수 있습니다.</p>
                    </div>

                    <div id="screener-placeholder" class="text-center py-5 text-muted">
                        <i class="bi bi-funnel fs-1"></i>
                        <p class="mt-2">필터를 설정하고 "스크리닝 실행" 버튼을 클릭하세요.</p>
                        <p class="small">11개 기술적 지표를 종합한 모멘텀 점수로 종목을 스크리닝합니다.</p>
                    </div>

                    <div id="screener-results" style="display: none;">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-dark sticky-top">
                                    <tr>
                                        <th style="min-width: 70px;">종목코드</th>
                                        <th style="min-width: 100px;">종목명</th>
                                        <th class="text-end" style="min-width: 80px;">현재가</th>
                                        <th class="text-center" style="min-width: 70px;">종합점수</th>
                                        <th class="text-center" style="min-width: 60px;">신호</th>
                                        <th class="text-center" style="min-width: 50px;">추세</th>
                                        <th class="text-center" style="min-width: 50px;">오실</th>
                                        <th class="text-center" style="min-width: 50px;">거래량</th>
                                        <th class="text-center" style="min-width: 40px;">RSI</th>
                                        <th class="text-center" style="min-width: 40px;">MACD</th>
                                        <th class="text-center" style="min-width: 40px;">ADX</th>
                                        <th class="text-center" style="min-width: 40px;">STOCH</th>
                                        <th class="text-center" style="min-width: 40px;">MFI</th>
                                    </tr>
                                </thead>
                                <tbody id="results-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const signalFilter = document.getElementById('signalFilter');
    const stateFilter = document.getElementById('stateFilter');
    const minScore = document.getElementById('minScore');
    const maxScore = document.getElementById('maxScore');
    const forceRecompute = document.getElementById('forceRecompute');
    const runButton = document.getElementById('runScreener');

    // Run screener
    runButton.addEventListener('click', async function() {
        // Build query params
        let params = new URLSearchParams();

        const signal = signalFilter.value;
        const state = stateFilter.value;
        const minVal = minScore.value;
        const maxVal = maxScore.value;
        const force = forceRecompute.checked;

        if (signal) params.append('signal', signal);
        if (state) params.append('state', state);
        if (minVal) params.append('min_score', minVal);
        if (maxVal) params.append('max_score', maxVal);
        if (force) params.append('force', 'true');

        // Show loading
        document.getElementById('screener-placeholder').style.display = 'none';
        document.getElementById('screener-results').style.display = 'none';
        document.getElementById('screener-loading').style.display = 'block';

        try {
            const response = await fetch(`/api/screener/momentum/?${params.toString()}`);
            const data = await response.json();

            if (data.error) {
                throw new Error(data.error);
            }

            displayResults(data.results);
        } catch (error) {
            alert('스크리닝 중 오류가 발생했습니다: ' + error.message);
            document.getElementById('screener-loading').style.display = 'none';
            document.getElementById('screener-placeholder').style.display = 'block';
        }
    });

    function getScoreClass(score) {
        if (score === null || score === undefined) return 'text-muted';
        if (score >= 80) return 'text-success fw-bold';
        if (score >= 65) return 'text-success';
        if (score >= 55) return 'text-success-subtle';
        if (score >= 45) return 'text-secondary';
        if (score >= 35) return 'text-danger-subtle';
        if (score >= 20) return 'text-danger';
        return 'text-danger fw-bold';
    }

    function getScoreBadgeClass(score) {
        if (score === null || score === undefined) return 'bg-secondary';
        if (score >= 80) return 'bg-success';
        if (score >= 65) return 'bg-success bg-opacity-75';
        if (score >= 55) return 'bg-info bg-opacity-75';
        if (score >= 45) return 'bg-secondary';
        if (score >= 35) return 'bg-warning bg-opacity-75';
        if (score >= 20) return 'bg-danger bg-opacity-75';
        return 'bg-danger';
    }

    function formatScore(score) {
        if (score === null || score === undefined) return '-';
        return score.toFixed(0);
    }

    function displayResults(results) {
        document.getElementById('screener-loading').style.display = 'none';
        document.getElementById('screener-results').style.display = 'block';
        document.getElementById('result-count').textContent = results.length + '건';

        const tbody = document.getElementById('results-body');
        tbody.innerHTML = '';

        if (results.length === 0) {
            tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted py-4">조건에 맞는 종목이 없습니다.</td></tr>';
            return;
        }

        results.forEach(stock => {
            const row = document.createElement('tr');

            // Signal badge
            let signalBadge = '';
            if (stock.signal === 1) {
                signalBadge = '<span class="badge bg-success">매수</span>';
            } else if (stock.signal === -1) {
                signalBadge = '<span class="badge bg-danger">매도</span>';
            } else {
                signalBadge = '<span class="badge bg-secondary">-</span>';
            }

            // Get indicator scores
            const scores = stock.indicator_scores || {};

            row.innerHTML = `
                <td><a href="/stock/${stock.symbol}/">${stock.symbol}</a></td>
                <td class="text-truncate" style="max-width: 100px;" title="${stock.name}">${stock.name}</td>
                <td class="text-end">${stock.price ? stock.price.toLocaleString() : '-'}</td>
                <td class="text-center">
                    <span class="badge ${getScoreBadgeClass(stock.total_score)}">${formatScore(stock.total_score)}</span>
                </td>
                <td class="text-center">${signalBadge}</td>
                <td class="text-center ${getScoreClass(stock.trend_score)}">${formatScore(stock.trend_score)}</td>
                <td class="text-center ${getScoreClass(stock.oscillator_score)}">${formatScore(stock.oscillator_score)}</td>
                <td class="text-center ${getScoreClass(stock.volume_score)}">${formatScore(stock.volume_score)}</td>
                <td class="text-center ${getScoreClass(scores.RSI)}">${formatScore(scores.RSI)}</td>
                <td class="text-center ${getScoreClass(scores.MACD)}">${formatScore(scores.MACD)}</td>
                <td class="text-center ${getScoreClass(scores.ADX)}">${formatScore(scores.ADX)}</td>
                <td class="text-center ${getScoreClass(scores.Stochastic)}">${formatScore(scores.Stochastic)}</td>
                <td class="text-center ${getScoreClass(scores.MFI)}">${formatScore(scores.MFI)}</td>
            `;

            tbody.appendChild(row);
        });
    }
});
</script>
{% endblock %}
